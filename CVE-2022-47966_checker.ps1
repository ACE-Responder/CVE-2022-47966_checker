Param(
  $AccessLogPath = 'C:\Program Files\ManageEngine\ServiceDesk\logs\access\',
  $output = 'C:\aceresponder_CVE-2022-47966_checker.csv'
)

Write-Host "ACE Responder CVE-2022-47966 Checker"
Write-Host "[i] checking for access logs"

$sresponse = $false
$payloadfound = $false 

$accessexists = test-path -path ($AccessLogPath + '*')
if ($accessexists) {

  Get-ChildItem $AccessLogPath -filter * | % {
    $f = [IO.File]::OpenText($AccessLogPath + $_)
    while ($f.Peek() -ge 0) {
      $line = $f.ReadLine()
      $matches = @()
      if ($line -match '^([^\s]+)\s([^\s]+)\s+-\s+[^\s]+\s+[^\s]+\s+[^\s]+\s+([0-9]+)\s+([^\s]+)\s+([^\s]+)\s+([^\s]+)\s+([^\s]+)\s+-\s+\{SAMLResponse\s+:\s+([^\s\}]+)\}') {
        $sresponse = $true
        Write-Host '[+] SAMLResponse found' $matches[1] $matches[2] -ForegroundColor Yellow
        $urldecode = [System.Web.HttpUtility]::UrlDecode($matches[8])
        $b64decoded = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($urldecode))

        $robj = [PSCustomObject]@{
          date        = $matches[1]
          time        = $matches[2]
          code        = $matches[3]
          source      = $matches[5]
          destination = $matches[6]
          source_port = $matches[7]
          raw         = $matches[0]
          decoded     = $b64decoded
        }
        $matches = $()
        $payload = ''
        if ($b64decoded -match 'exec\(.*\,([^\)]+)\)') {
          $payload = $matches[1]
          $payloadfound = $true
          Write-Host '  [+] Payload found' $matches[1] $matches[2] -ForegroundColor Green
        }
        $robj | Add-Member -MemberType NoteProperty -Name 'payload' -Value $payload 

        $robj | Export-Csv -path $output -NoTypeInformation -Append
      }
    }
    $f.Dispose()
  }
  if ($sresponse) {
    Write-Host "SAMLResponse entries found in access logs."
    if ($payloadfound) {
      Write-Host "  [!] CVE-2022-47966 IOC(s) identified."
    }
    Write-Host "Results in " $output
  }
  else {
    Write-Host "No IOCs found in access logs."
  }
}
else {
  Write-Host "[i] Can't find access logs in " $AccessLogPath ". Try specifying the path with -AccessLogPath"
}
